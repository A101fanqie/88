<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理系统</title>
    <style>
        /* 这里粘贴 admin.css 的全部内容 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f4f6f9 0%, #e9ecef 100%);
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* 其余 CSS 代码... */
    </style>
</head>
<body>
    <div class="admin-container">
        <nav class="sidebar">
            <div class="logo">
                <h2>订单管理</h2>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#dashboard">订单列表</a></li>
                <li><a href="#customers">客户管理</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="top-bar">
                <div class="search-box">
                    <input type="text" placeholder="搜索订单...">
                </div>
                <button onclick="rechargeByWechat()" class="action-btn" style="background: #4CAF50; color: white;">
                    微信号充值
                </button>
                <button onclick="refreshData()" class="action-btn">刷新数据</button>
                <button onclick="exportData('orders')" class="action-btn">导出数据</button>
            </header>

            <div class="content-area">
                <div class="dashboard-section">
                    <h2>订单数据</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>今日订单</h3>
                            <p class="stat-number">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>待处理订单</h3>
                            <p class="stat-number">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>总订单数</h3>
                            <p class="stat-number">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>总收入</h3>
                            <p class="stat-number">¥0.00</p>
                        </div>
                        <div class="stat-card">
                            <h3>总积分</h3>
                            <p class="stat-number">0 积分</p>
                        </div>
                    </div>

                    <div class="orders-list">
                        <h3>订单列表</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>订单ID</th>
                                    <th>微信号</th>
                                    <th>产品</th>
                                    <th>课程</th>
                                    <th>状态</th>
                                    <th>时间</th>
                                    <th>积分</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="orderTableBody">
                                <!-- 订单数据将通过 JavaScript 动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="customers-section" style="display: none;">
                    <div class="customers-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>客户管理</h2>
                        <button onclick="addNewCustomer()" class="action-btn" style="background: #4CAF50; color: white;">
                            添加客户
                        </button>
                    </div>
                    <div class="customers-list">
                        <table>
                            <thead>
                                <tr>
                                    <th>微信号</th>
                                    <th>当前积分</th>
                                    <th>注册时间</th>
                                    <th>最后充值</th>
                                    <th>总充值金额</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <!-- 客户数据将通过 JavaScript 动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDQJUz_Z4_CQZKotF9yDz3Hfa5T5KhU6BY",
            authDomain: "order-system-demo-d3f3c.firebaseapp.com",
            databaseURL: "https://order-system-demo-d3f3c-default-rtdb.firebaseio.com",
            projectId: "order-system-demo-d3f3c",
            storageBucket: "order-system-demo-d3f3c.appspot.com",
            messagingSenderId: "1015647261859",
            appId: "1:1015647261859:web:b7d51b89d0f8f7d7dd7b47"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 添加实时订单监听
        database.ref('orders').on('child_added', function(snapshot) {
            try {
                const newOrder = snapshot.val();
                if (newOrder) {
                    console.log('收到新订单:', newOrder);
                    
                    // 播放提示音
                    const audio = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1...');
                    audio.play().catch(e => console.log('无法播放提示音:', e));
                    
                    // 显示通知
                    showToast(`收到新订单：${newOrder.wechat}`, 'success');
                    
                    // 发送桌面通知
                    if (Notification.permission === "granted") {
                        new Notification("新订单提醒", {
                            body: `收到新订单\n微信号：${newOrder.wechat}`,
                            icon: "/favicon.ico"
                        });
                    }
                    
                    // 刷新订单列表
                    loadOrders();
                    
                    // 更新标题提示
                    updateTitleNotification(true);
                    
                    // 高亮显示新订单
                    highlightNewOrder(newOrder.id);
                }
            } catch (error) {
                console.error('处理新订单失败:', error);
                showToast('处理新订单失败', 'error');
            }
        });

        // 修改更新订单列表函数
        function updateOrderList(orders) {
            const tbody = document.getElementById('orderTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">暂无订单数据</td></tr>';
                return;
            }

            orders.forEach(order => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-order-id', order.id);
                
                // 根据订单状态设置行样式
                if (order.status === 'new') {
                    tr.classList.add('new-order');
                }
                
                tr.innerHTML = `
                    <td>${order.id}</td>
                    <td>
                        <div style="font-weight: bold;">${order.wechat}</div>
                        <div style="font-size: 12px; color: #666;">${order.phone}</div>
                    </td>
                    <td>
                        <div>${order.product}</div>
                        <div style="font-size: 12px; color: #666;">课程：${order.course}</div>
                    </td>
                    <td style="font-size: 12px;">${order.password}</td>
                    <td>
                        <span class="status-badge ${order.status}" style="
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                            ${order.status === 'new' ? 'background: #ffeb3b; color: #000;' : 
                              order.status === 'complete' ? 'background: #4CAF50; color: #fff;' : ''}
                        ">
                            ${getStatusText(order.status)}
                        </span>
                    </td>
                    <td>
                        <div>${order.timestamp}</div>
                        ${order.updateTime ? `<div style="font-size: 12px; color: #666;">更新：${order.updateTime}</div>` : ''}
                    </td>
                    <td>${order.points} 积分</td>
                    <td>
                        ${order.status === 'new' ? `
                            <button onclick="handleOrder('${order.id}', 'complete')" class="action-btn complete" style="background: #4CAF50; color: white;">
                                完成
                            </button>
                        ` : ''}
                        <button onclick="viewOrderDetails('${order.id}')" class="action-btn" style="background: #2196F3; color: white;">
                            详情
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="action-btn delete" style="background: #f44336; color: white;">
                            删除
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 改更新统计数据函数
        function updateStats(orders) {
            const today = new Date().toDateString();
            const stats = {
                todayOrders: orders.filter(order => 
                    new Date(order.timestamp).toDateString() === today
                ).length,
                pendingOrders: orders.filter(order => order.status === 'new').length,
                totalOrders: orders.length,
                totalIncome: orders.length * 1.3,
                totalPoints: orders.reduce((sum, order) => sum + (order.points || 0), 0)
            };

            document.querySelector('.stat-card:nth-child(1) .stat-number').textContent = stats.todayOrders;
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = stats.pendingOrders;
            document.querySelector('.stat-card:nth-child(3) .stat-number').textContent = stats.totalOrders;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = `¥${stats.totalIncome.toFixed(2)}`;
            document.querySelector('.stat-card:nth-child(5) .stat-number').textContent = 
                `${stats.totalPoints.toFixed(2)} 积分`;
        }

        // 处理订单状态
        async function handleOrder(orderId, action) {
            try {
                if (!confirm(`确定要将订单标记为${action === 'complete' ? '完成' : action}吗？`)) {
                    return;
                }
                
                await database.ref('orders/' + orderId).update({
                    status: action,
                    updateTime: new Date().toLocaleString()
                });
                
                showToast('订单状态已更新', 'success');
                loadOrders(); // 刷新订单列表
            } catch (error) {
                console.error('处理订单失败:', error);
                showToast('操作失败，请重试', 'error');
            }
        }

        // 删除订单
        async function deleteOrder(orderId) {
            if (!confirm('确定要删除这个订单吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                await database.ref('orders/' + orderId).remove();
                showToast('订单已删除', 'success');
                loadOrders(); // 刷新订单列表
            } catch (error) {
                console.error('删除订单失败:', error);
                showToast('删除失败，请重试', 'error');
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'new': '新订单',
                'complete': '已完成'
            };
            return statusMap[status] || status;
        }

        // 搜索功能
        document.querySelector('.search-box input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#orderTableBody tr, #customersTableBody tr');
            let found = false;
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const match = text.includes(searchTerm);
                row.style.display = match ? '' : 'none';
                if (match) found = true;
            });

            if (searchTerm) {
                showToast(`找到 ${found ? '匹配的记录' : '没有匹配的记录'}`, found ? 'success' : 'warning');
            }
        });

        // 修改微信号充值功能
        async function rechargeByWechat() {
            const wechat = prompt('请输入要充值的微信号：');
            if (!wechat) return;

            try {
                // 查询用户当前积分
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val();
                
                if (!userData) {
                    alert('未找到该微信号，请先添加客户！');
                    return;
                }

                // 显示充值对话框
                const content = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>用户：${wechat}</h3>
                            <div style="font-size: 24px; color: ${userData.points < 1.3 ? '#f44336' : '#4CAF50'};">
                                当前积分：${userData.points.toFixed(2)}
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label>充值金额：</label>
                                <input type="number" id="rechargeAmount" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">1元 = 1积分</p>
                            </div>
                            <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <button onclick="addPoints('${wechat}', 10)" class="action-btn">充值10元</button>
                                <button onclick="addPoints('${wechat}', 50)" class="action-btn">充值50元</button>
                                <button onclick="addPoints('${wechat}', 100)" class="action-btn">充值100元</button>
                            </div>
                            <div style="margin-top: 15px;">
                                <button onclick="confirmRecharge('${wechat}')" class="action-btn" style="background: #4CAF50; color: white; width: 100%;">
                                    确认自定义充值
                                </button>
                            </div>
                        </div>
                        ${userData.lastRecharge ? `
                            <div style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                                <div style="font-size: 13px; color: #666;">
                                    上次充值：${userData.lastRecharge.amount} 元<br>
                                    时间：${userData.lastRecharge.timestamp}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                showDialog('充值管理', content);
            } catch (error) {
                console.error('获取用户数据失败:', error);
                alert('获取用户数据失败，请重试！');
            }
        }

        // 修改确认充值功能
        async function confirmRecharge(wechat) {
            const amountInput = document.getElementById('rechargeAmount');
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                alert('请输入有效的充值金额');
                return;
            }

            try {
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val() || { points: 0 };
                const newPoints = userData.points + amount;
                
                // 记录充值历史
                const rechargeData = {
                    amount: amount,
                    timestamp: new Date().toLocaleString(),
                    beforePoints: userData.points,
                    afterPoints: newPoints,
                    operator: 'admin'
                };

                // 更新用户积分和充值记录
                await database.ref('users/' + wechat).update({
                    points: newPoints,
                    lastRecharge: rechargeData,
                    [`rechargeHistory/${Date.now()}`]: rechargeData
                });

                alert(`充值成功！\n用户：${wechat}\n充值金额：${amount}元\n当前分：${newPoints.toFixed(2)}`);
                document.querySelector('.custom-dialog').remove();
                loadCustomers(); // 刷新客户列表
            } catch (error) {
                console.error('充值失败:', error);
                alert('充值失败，请重试！');
            }
        }

        // 添加查看积分历史功能
        async function showPointsHistory(wechat) {
            try {
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val() || { points: 0 };
                
                let historyText = `用户：${wechat}\n当前积分：${userData.points.toFixed(2)}\n\n充值记录：\n`;
                
                if (userData.rechargeHistory) {
                    Object.values(userData.rechargeHistory).forEach(record => {
                        historyText += `\n时：${record.timestamp}`;
                        historyText += `\n充值：${record.amount}`;
                        historyText += `\n变化：${record.beforePoints.toFixed(2)} → ${record.afterPoints.toFixed(2)}`;
                        historyText += `\n作者：${record.operator}\n`;
                    });
                } else {
                    historyText += '暂无充值记录';
                }
                
                alert(historyText);
            } catch (error) {
                console.error('获取积分历史失败:', error);
                alert('获取积分史失败，请重试！');
            }
        }

        // 添加积分管理功能
        async function managePoints(wechat) {
            try {
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val() || { points: 0 };
                
                const content = `
                    <div style="margin-bottom: 20px;">
                        <h3>用户：${wechat}</h3>
                        <p>当前积分：${userData.points.toFixed(2)}</p>
                        <div style="margin-top: 15px;">
                            <button onclick="addPoints('${wechat}', 10)" class="action-btn">充值10分</button>
                            <button onclick="addPoints('${wechat}', 50)" class="action-btn">充值50积分</button>
                            <button onclick="addPoints('${wechat}', 100)" class="action-btn">充值100积分</button>
                            <button onclick="showCustomRecharge('${wechat}')" class="action-btn">自定义充值</button>
                            <button onclick="resetPoints('${wechat}')" class="action-btn" style="background: #f44336; color: white;">重置积分</button>
                        </div>
                        <div style="margin-top: 20px;">
                            <h4>积分历史：</h4>
                            <div style="max-height: 200px; overflow-y: auto; margin-top: 10px;">
                                ${getPointsHistory(userData)}
                            </div>
                        </div>
                    </div>
                `;
                
                showDialog('积分管理', content);
            } catch (error) {
                console.error('获取用户数据失败:', error);
                alert('获取用户数据失败，请重试！');
            }
        }

        // 获取积分历史记录
        function getPointsHistory(userData) {
            if (!userData.rechargeHistory) {
                return '<p style="color: #666;">暂无充值记录</p>';
            }

            return Object.values(userData.rechargeHistory)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .map(record => `
                    <div style="margin-bottom: 10px; padding: 8px; border-bottom: 1px solid #ddd;">
                        <div>时间：${record.timestamp}</div>
                        <div>充值：${record.amount} 积分</div>
                        <div>变化：${record.beforePoints.toFixed(2)} → ${record.afterPoints.toFixed(2)}</div>
                        <div>操作者：${record.operator}</div>
                    </div>
                `).join('');
        }

        // 添加自定义充值对话框
        function showCustomRecharge(wechat) {
            const amount = prompt('请输入充值金额：');
            if (amount && !isNaN(amount)) {
                addPoints(wechat, parseFloat(amount));
            }
        }

        // 添加对话框组件
        function showDialog(title, content) {
            const dialog = document.createElement('div');
            dialog.className = 'custom-dialog';
            dialog.innerHTML = `
                <div class="dialog-content">
                    <div class="dialog-header">
                        <h3>${title}</h3>
                        <button onclick="this.closest('.custom-dialog').remove()" class="close-btn">&times;</button>
                    </div>
                    <div class="dialog-body">
                        ${content}
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        // 添加对话框样式
        const dialogStyle = document.createElement('style');
        dialogStyle.textContent = `
            .custom-dialog {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .dialog-content {
                background: white;
                padding: 20px;
                border-radius: 10px;
                min-width: 300px;
                max-width: 500px;
            }
            .dialog-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .close-btn {
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
            }
        `;
        document.head.appendChild(dialogStyle);

        // 添加导出用户历史记录功能
        function exportUserHistory(wechat) {
            database.ref('users/' + wechat).once('value')
                .then((snapshot) => {
                    const userData = snapshot.val() || { points: 0 };
                    let csvContent = "data:text/csv;charset=utf-8,\n";
                    csvContent += "时间,类型,金额,操作前积分,操作后积分,操作者\n";

                    if (userData.rechargeHistory) {
                        Object.values(userData.rechargeHistory).forEach(record => {
                            csvContent += `${record.timestamp},充值,${record.amount},${record.beforePoints},${record.afterPoints},${record.operator}\n`;
                        });
                    }

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `${wechat}_history.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('导出历史记录失败:', error);
                    showToast('导出失败，请重试！', 'error');
                });
        }

        // 添加重置积分功能
        async function resetPoints(wechat) {
            if (confirm(`确定要重置 ${wechat} 的积分吗？`)) {
                try {
                    // 录重置历史
                    const snapshot = await database.ref('users/' + wechat).once('value');
                    const userData = snapshot.val() || { points: 0 };
                    
                    const resetData = {
                        timestamp: new Date().toLocaleString(),
                        beforePoints: userData.points,
                        afterPoints: 0,
                        operator: 'admin',
                        type: 'reset'
                    };

                    // 更新用户积分和记录
                    await database.ref('users/' + wechat).update({
                        points: 0,
                        lastReset: resetData,
                        [`pointsHistory/${Date.now()}`]: resetData
                    });

                    alert(`已重置 ${wechat} 的积分为0`);
                    loadOrders(); // 刷新数据
                } catch (error) {
                    console.error('重置积分失败:', error);
                    alert('重置失败，请重试！');
                }
            }
        }

        // 修改添加客户功能
        function addNewCustomer() {
            const content = `
                <div style="margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">微信号：</label>
                        <input type="text" id="newCustomerWechat" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">初始积分：</label>
                        <input type="number" id="newCustomerPoints" value="0" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="text-align: center;">
                        <button onclick="confirmAddCustomer()" class="action-btn" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                            确认添加
                        </button>
                    </div>
                </div>
            `;
            
            showDialog('添加客户', content);
        }

        // 修改确认添加客户功能
        async function confirmAddCustomer() {
            const wechat = document.getElementById('newCustomerWechat').value.trim();
            const points = parseFloat(document.getElementById('newCustomerPoints').value) || 0;
            
            if (!wechat) {
                showToast('请输入微信号', 'error');
                return;
            }
            
            try {
                showLoading(true);
                
                // 检查微信号是否已存在
                const snapshot = await database.ref('users/' + wechat).once('value');
                if (snapshot.val()) {
                    showToast('该微信号已存在！', 'error');
                    return;
                }
                
                // 创建新用户
                const userData = {
                    wechat: wechat,
                    points: points,
                    registerTime: new Date().toLocaleString(),
                    lastRecharge: points > 0 ? {
                        amount: points,
                        timestamp: new Date().toLocaleString(),
                        beforePoints: 0,
                        afterPoints: points,
                        operator: 'admin'
                    } : null
                };

                // 保存到数据库
                await database.ref('users/' + wechat).set(userData);
                
                // 显示成功消息
                showToast('添加客户成功！', 'success');
                
                // 关闭对话框
                const dialog = document.querySelector('.custom-dialog');
                if (dialog) {
                    dialog.remove();
                }
                
                // 刷新客户列表
                loadCustomers();
                
            } catch (error) {
                console.error('添加客户失败:', error);
                showToast('添加客户失败，请重试！', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 修改加载客户列表函数
        async function loadCustomers() {
            showLoading(true);
            try {
                const snapshot = await database.ref('users').once('value');
                const users = snapshot.val() || {};
                
                const tbody = document.getElementById('customersTableBody');
                tbody.innerHTML = '';
                
                Object.entries(users).forEach(([wechat, userData]) => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-wechat', wechat);
                    
                    // 计算总充值金额
                    const totalRecharge = userData.rechargeHistory ? 
                        Object.values(userData.rechargeHistory).reduce((sum, record) => sum + record.amount, 0) : 0;
                    
                    tr.innerHTML = `
                        <td>${wechat}</td>
                        <td>
                            <div style="color: ${userData.points < 1.3 ? '#f44336' : '#4CAF50'};">
                                ${userData.points?.toFixed(2) || '0.00'} 积分
                            </div>
                        </td>
                        <td>${userData.registerTime || '未知'}</td>
                        <td>${userData.lastRecharge?.timestamp || '无充值记录'}</td>
                        <td>¥${totalRecharge.toFixed(2)}</td>
                        <td>
                            <button onclick="rechargePoints('${wechat}')" class="action-btn" style="background: #4CAF50; color: white;">充值</button>
                            <button onclick="viewCustomerDetails('${wechat}')" class="action-btn">详情</button>
                            <button onclick="resetCustomerPoints('${wechat}')" class="action-btn" style="background: #f44336; color: white;">重置</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('加载客户数据失败:', error);
                showToast('加载客户数据失败，请重试', 'error');
            } finally {
                showLoading(false);
            }
        }

        // 修改页面切换逻辑
        let isRefreshing = false;
        let lastRefreshTime = Date.now();

        // 修改自动刷新逻辑
        function setupAutoRefresh() {
            setInterval(() => {
                // 如果用户正在操作，延刷新
                if (isRefreshing || Date.now() - lastRefreshTime < 5000) {
                    return;
                }
                
                const currentSection = document.querySelector('.section.active');
                if (currentSection) {
                    if (currentSection.classList.contains('dashboard-section')) {
                        loadOrders(true); // 静默刷新
                    } else if (currentSection.classList.contains('customers-section')) {
                        loadCustomers(true); // 静默刷新
                    }
                }
            }, 30000);
        }

        // 添加用户交互监听
        document.addEventListener('mousemove', () => {
            lastRefreshTime = Date.now();
        });

        document.addEventListener('keydown', () => {
            lastRefreshTime = Date.now();
        });

        // 添加实时数据更新监听
        database.ref('users').on('child_changed', function(snapshot) {
            const userData = snapshot.val();
            if (userData) {
                // 更新客户列表中的对应行
                const row = document.querySelector(`tr[data-wechat="${userData.wechat}"]`);
                if (row) {
                    updateCustomerRow(row, userData);
                }
                // 如果在客户管理页面，刷新整个列表
                if (document.querySelector('.customers-section').style.display === 'block') {
                    loadCustomers();
                }
            }
        });

        // 添加加载状态显示
        function showLoading(show = true) {
            const loadingEl = document.querySelector('.loading') || document.createElement('div');
            if (!document.querySelector('.loading')) {
                loadingEl.className = 'loading';
                loadingEl.innerHTML = `
                    <div class="loading-spinner"></div>
                    <div class="loading-text">处理中...</div>
                `;
                document.body.appendChild(loadingEl);
            }
            loadingEl.style.display = show ? 'flex' : 'none';
        }

        // 添加功提示
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 修改导出数据功能
        function exportData(type) {
            try {
                let data;
                let filename;
                
                if (type === 'orders') {
                    database.ref('orders').once('value').then(snapshot => {
                        const orders = snapshot.val() || {};
                        data = Object.values(orders);
                        filename = `订单数据_${new Date().toLocaleDateString()}.json`;
                        downloadJson(data, filename);
                    });
                } else if (type === 'customers') {
                    database.ref('users').once('value').then(snapshot => {
                        const users = snapshot.val() || {};
                        data = Object.values(users);
                        filename = `客户数据_${new Date().toLocaleDateString()}.json`;
                        downloadJson(data, filename);
                    });
                }
            } catch (error) {
                console.error('导出数据失败:', error);
                showToast('导出失败，请重试！', 'error');
            }
        }

        // 添加下载 JSON 文件函数
        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('导出成功！', 'success');
        }

        // 添加数据刷新功能
        function refreshData() {
            const currentSection = document.querySelector('.section.active');
            if (currentSection.classList.contains('dashboard-section')) {
                loadOrders();
            } else if (currentSection.classList.contains('customers-section')) {
                loadCustomers();
            }
            showToast('数据已刷新', 'success');
        }

        // 添加刷新按钮到顶部栏
        const refreshBtn = document.createElement('button');
        refreshBtn.className = 'action-btn';
        refreshBtn.innerHTML = '刷新数据';
        refreshBtn.onclick = refreshData;
        document.querySelector('.top-bar').appendChild(refreshBtn);

        // 添加导出按钮到顶部栏
        const exportBtn = document.createElement('button');
        exportBtn.className = 'action-btn';
        exportBtn.style.marginLeft = '10px';
        exportBtn.innerHTML = '导出数据';
        exportBtn.onclick = () => {
            const currentSection = document.querySelector('.section.active');
            if (currentSection.classList.contains('dashboard-section')) {
                exportData('orders');
            } else if (currentSection.classList.contains('customers-section')) {
                exportData('customers');
            }
        };
        document.querySelector('.top-bar').appendChild(exportBtn);

        // 添加连接状态检查
        let connectionAttempts = 0;
        database.ref('.info/connected').on('value', function(snap) {
            if (snap.val()) {
                console.log('数据库连接成功');
                connectionAttempts = 0;
                showToast('连接成功', 'success');
                
                // 连接成功后立即加载数据
                loadOrders();
                if (document.querySelector('.customers-section').style.display === 'block') {
                    loadCustomers();
                }
            } else {
                console.log('数据库连接断开');
                showToast('连接断开，正在重新连接...', 'warning');
                if (connectionAttempts < 5) {
                    connectionAttempts++;
                    setTimeout(() => {
                        database.goOnline();
                    }, 1000 * connectionAttempts);
                } else {
                    showToast('连接失败，请刷新页面', 'error');
                }
            }
        });

        // 添加网络状态监听
        window.addEventListener('online', function() {
            database.goOnline();
            showToast('网络已恢复', 'success');
            loadOrders(); // 重新加载数据
        });

        window.addEventListener('offline', function() {
            showToast('网络已断开', 'error');
        });

        // 添加页面可见性监听
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // 页面变为可见时刷新数据
                loadOrders();
                if (document.querySelector('.customers-section').style.display === 'block') {
                    loadCustomers();
                }
            }
        });

        // 添加页面关闭前确认
        window.addEventListener('beforeunload', function(e) {
            if (document.querySelector('.new-order')) {
                e.preventDefault();
                e.returnValue = '有新订单未处，确定离开吗？';
            }
        });

        // 添加订单通知声音
        const notificationSound = new Audio('data:audio/mpeg;base64,SUQzBAAAAAAAI1...');

        // 添加桌面通知
        if (Notification.permission === "granted") {
            new Notification("新订单提醒", {
                body: `收到新订单\n微信号：${newOrder.wechat}`,
                icon: "/favicon.ico"
            });
        }

        // 添加订单高亮显示
        function highlightNewOrder(orderId) {
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (orderRow) {
                orderRow.style.animation = 'highlight 2s';
            }
        }

        // 添加响应式设计样式
        const responsiveStyle = document.createElement('style');
        responsiveStyle.textContent = `
            /* 桌面端样式 */
            @media (min-width: 769px) {
                .sidebar {
                    width: 250px;
                }
                
                .stats-grid {
                    grid-template-columns: repeat(5, 1fr);
                    gap: 25px;
                }
                
                .search-box input {
                    width: 300px;
                }
                
                table {
                    font-size: 14px;
                }
                
                .action-btn {
                    padding: 8px 15px;
                    margin: 0 4px;
                }
            }

            /* 平板端样式 */
            @media (max-width: 768px) {
                .sidebar {
                    width: 70px;
                }
                
                .logo h2 {
                    display: none;
                }
                
                .nav-links li span {
                    display: none;
                }
                
                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                }
                
                .search-box input {
                    width: 200px;
                }
            }

            /* 手机端样式 */
            @media (max-width: 480px) {
                .admin-container {
                    flex-direction: column;
                }
                
                .sidebar {
                    width: 100%;
                    height: auto;
                    padding: 10px;
                }
                
                .nav-links {
                    display: flex;
                    justify-content: space-around;
                    padding: 10px 0;
                }
                
                .nav-links li {
                    padding: 8px 15px;
                    margin: 0;
                }
                
                .main-content {
                    padding: 10px;
                }
                
                .top-bar {
                    flex-direction: column;
                    gap: 10px;
                    padding: 10px;
                }
                
                .search-box input {
                    width: 100%;
                }
                
                .stats-grid {
                    grid-template-columns: 1fr;
                    gap: 10px;
                }
                
                table {
                    font-size: 12px;
                }
                
                td, th {
                    padding: 8px;
                }
                
                .action-btn {
                    padding: 6px 10px;
                    margin: 2px;
                    font-size: 11px;
                }
                
                /* 在手机端优化表格显示 */
                .orders-list, .customers-list {
                    overflow-x: auto;
                }
                
                /* 调整对话框大小 */
                .dialog-content {
                    width: 90%;
                    margin: 10px;
                    padding: 15px;
                }
                
                /* 调整提示消息位置 */
                .toast {
                    width: 90%;
                    left: 50%;
                    transform: translateX(-50%);
                    right: auto;
                }
                
                .toast.show {
                    right: auto;
                }
            }
        `;

        document.head.appendChild(responsiveStyle);

        // 添加触摸事件支持
        if ('ontouchstart' in window) {
            document.body.addEventListener('touchstart', function() {});
        }

        // 修改表格滚动处理
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
            const wrapper = document.createElement('div');
            wrapper.style.overflowX = 'auto';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        });

        // 添加移动端菜单切换
        document.querySelectorAll('.nav-links a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (window.innerWidth <= 480) {
                    // 在手机端点击导航后自动隐藏菜单
                    document.querySelector('.sidebar').style.height = 'auto';
                }
            });
        });

        // 添加查看订单详情功能
        async function viewOrderDetails(orderId) {
            try {
                const snapshot = await database.ref('orders/' + orderId).once('value');
                const order = snapshot.val();
                
                if (!order) {
                    showToast('未找到订单数据', 'error');
                    return;
                }
                
                const content = `
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #1a237e; margin-bottom: 10px;">订单信息</h3>
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                                <div style="margin-bottom: 10px;">
                                    <strong>订单号：</strong>${order.id}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>微信号：</strong>${order.wechat}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>电话：</strong>${order.phone}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>密码：</strong>${order.password}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>产品：</strong>${order.product}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>课程：</strong>${order.course}
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>状态：</strong>
                                    <span class="status-badge ${order.status}">
                                        ${getStatusText(order.status)}
                                    </span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <strong>下单时间：</strong>${order.timestamp}
                                </div>
                                <div>
                                    <strong>消耗积分：</strong>${order.points}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            ${order.status === 'new' ? `
                                <button onclick="handleOrder('${order.id}', 'complete')" class="action-btn" style="background: #4CAF50; color: white;">
                                    标记完成
                                </button>
                            ` : ''}
                            <button onclick="deleteOrder('${order.id}')" class="action-btn" style="background: #f44336; color: white;">
                                删除订单
                            </button>
                        </div>
                    </div>
                `;
                
                showDialog('订单详情', content);
            } catch (error) {
                console.error('获取订单详情失败:', error);
                showToast('获取订单详情失败', 'error');
            }
        }

        // 添加高级界面优化
        const advancedStyle = document.createElement('style');
        advancedStyle.textContent = `
            /* 优化侧边栏 */
            .sidebar {
                background: linear-gradient(180deg, #1a237e 0%, #283593 100%);
                position: fixed;
                height: 100vh;
                z-index: 1000;
                transition: width 0.3s ease;
            }

            /* 优化主内容区域 */
            .main-content {
                margin-left: 250px;
                padding: 20px;
                transition: margin-left 0.3s ease;
            }

            /* 优化统计卡片 */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.05);
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
                transform: translateX(-100%);
                transition: transform 0.6s ease;
            }

            .stat-card:hover::before {
                transform: translateX(100%);
            }

            /* 优化表格样式 */
            .orders-list, .customers-list {
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.05);
                overflow: hidden;
            }

            table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
            }

            th {
                background: #f8f9fa;
                padding: 15px;
                font-weight: 600;
                color: #444;
                position: sticky;
                top: 0;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            td {
                padding: 15px;
                border-bottom: 1px solid #eee;
                transition: all 0.3s ease;
            }

            tr:hover td {
                background: #f8f9fa;
                transform: scale(1.01);
            }

            /* 优化按钮样式 */
            .action-btn {
                padding: 8px 15px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .action-btn::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(255,255,255,0.2);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.3s ease, height 0.3s ease;
            }

            .action-btn:hover::after {
                width: 200%;
                height: 200%;
            }

            /* 优化搜索框 */
            .search-box {
                position: relative;
                margin-right: 20px;
            }

            .search-box input {
                padding: 12px 20px;
                padding-left: 40px;
                border: 2px solid #eee;
                border-radius: 25px;
                width: 300px;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .search-box::before {
                content: '🔍';
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
            }

            /* 优化状态标签 */
            .status-badge {
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 1px;
                display: inline-block;
                position: relative;
                overflow: hidden;
            }

            .status-badge::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
                transform: translateX(-100%);
                transition: transform 0.6s ease;
            }

            .status-badge:hover::after {
                transform: translateX(100%);
            }

            /* 添加加载动画 */
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255,255,255,0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
                backdrop-filter: blur(5px);
            }

            .loading-spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            /* 优化提示消息 */
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                background: white;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                transform: translateX(120%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .toast.show {
                transform: translateX(0);
            }

            /* 响应式优化 */
            @media (max-width: 768px) {
                .sidebar {
                    width: 70px;
                }

                .main-content {
                    margin-left: 70px;
                }

                .search-box input {
                    width: 200px;
                }

                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            @media (max-width: 480px) {
                .stats-grid {
                    grid-template-columns: 1fr;
                }

                .action-btn {
                    padding: 6px 12px;
                    font-size: 12px;
                }
            }
        `;

        document.head.appendChild(advancedStyle);

        // 修改导航菜单切换逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 导航菜单切换
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有 active 类
                    document.querySelectorAll('.nav-links li').forEach(li => {
                        li.classList.remove('active');
                    });
                    
                    // 添加 active 类到当前点击的项目
                    this.parentElement.classList.add('active');
                    
                    // 隐藏所有内容区域
                    document.querySelector('.dashboard-section').style.display = 'none';
                    document.querySelector('.customers-section').style.display = 'none';
                    
                    // 显示对应内容区域
                    const targetId = this.getAttribute('href').substring(1);
                    if (targetId === 'dashboard') {
                        document.querySelector('.dashboard-section').style.display = 'block';
                        loadOrders(); // 刷新订单数据
                    } else if (targetId === 'customers') {
                        document.querySelector('.customers-section').style.display = 'block';
                        loadCustomers(); // 刷新客户数据
                    }
                });
            });

            // 添加加载客户数据函数
            window.loadCustomers = async function() {
                showLoading(true);
                try {
                    const snapshot = await database.ref('users').once('value');
                    const users = snapshot.val() || {};
                    
                    const tbody = document.getElementById('customersTableBody');
                    tbody.innerHTML = '';
                    
                    Object.entries(users).forEach(([wechat, userData]) => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-wechat', wechat);
                        
                        // 计算总充值金额
                        const totalRecharge = userData.rechargeHistory ? 
                            Object.values(userData.rechargeHistory).reduce((sum, record) => sum + record.amount, 0) : 0;
                        
                        tr.innerHTML = `
                            <td>${wechat}</td>
                            <td>
                                <div style="color: ${userData.points < 1.3 ? '#f44336' : '#4CAF50'};">
                                    ${userData.points?.toFixed(2) || '0.00'} 积分
                                </div>
                            </td>
                            <td>${userData.registerTime || '未知'}</td>
                            <td>${userData.lastRecharge?.timestamp || '无充值记录'}</td>
                            <td>¥${totalRecharge.toFixed(2)}</td>
                            <td>
                                <button onclick="rechargePoints('${wechat}')" class="action-btn" style="background: #4CAF50; color: white;">充值</button>
                                <button onclick="viewCustomerDetails('${wechat}')" class="action-btn">详情</button>
                                <button onclick="resetCustomerPoints('${wechat}')" class="action-btn" style="background: #f44336; color: white;">重置</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch (error) {
                    console.error('加载客户数据失败:', error);
                    showToast('加载客户数据失败，请重试', 'error');
                } finally {
                    showLoading(false);
                }
            };

            // 初始化时加载默认页面
            const hash = window.location.hash || '#dashboard';
            document.querySelector(`a[href="${hash}"]`)?.click();
        });

        // 添加客户管理相关函数
        window.rechargePoints = async function(wechat) {
            try {
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val();
                
                if (!userData) {
                    showToast('未找到该用户', 'error');
                    return;
                }

                const content = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>用户：${wechat}</h3>
                            <div style="font-size: 24px; color: ${userData.points < 1.3 ? '#f44336' : '#4CAF50'};">
                                当前积分：${userData.points.toFixed(2)}
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label>充值金额：</label>
                                <input type="number" id="rechargeAmount" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <p style="color: #666; font-size: 12px; margin-top: 5px;">1元 = 1积分</p>
                            </div>
                            <div style="margin-top: 15px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <button onclick="addPoints('${wechat}', 10)" class="action-btn">充值10元</button>
                                <button onclick="addPoints('${wechat}', 50)" class="action-btn">充值50元</button>
                                <button onclick="addPoints('${wechat}', 100)" class="action-btn">充值100元</button>
                            </div>
                            <div style="margin-top: 15px;">
                                <button onclick="confirmRecharge('${wechat}')" class="action-btn" style="background: #4CAF50; color: white; width: 100%;">
                                    确认自定义充值
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                showDialog('充值管理', content);
            } catch (error) {
                console.error('获取用户数据失败:', error);
                showToast('获取用户数据失败', 'error');
            }
        };

        // 添加其他必要的函数
        window.viewCustomerDetails = async function(wechat) {
            try {
                const snapshot = await database.ref('users/' + wechat).once('value');
                const userData = snapshot.val();
                
                if (!userData) {
                    showToast('未找到用户数据', 'error');
                    return;
                }

                const content = `
                    <div style="margin-bottom: 20px;">
                        <h3>用户详情</h3>
                        <div style="margin-top: 15px; background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <div><strong>微信号：</strong>${wechat}</div>
                            <div><strong>当前积分：</strong>${userData.points?.toFixed(2) || '0.00'}</div>
                            <div><strong>注册时间：</strong>${userData.registerTime || '未知'}</div>
                            <div><strong>最后充值：</strong>${userData.lastRecharge?.timestamp || '无充值记录'}</div>
                        </div>
                    </div>
                `;
                
                showDialog('用户详情', content);
            } catch (error) {
                console.error('获取用户详情失败:', error);
                showToast('获取用户详情失败', 'error');
            }
        };
    </script>
</body>
</html> 